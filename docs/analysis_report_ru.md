# Аналитический отчет по проекту ngx_dynamic_healthcheck

## 1. Введение

Настоящий документ представляет собой детальный анализ OpenSource проекта [ngx_dynamic_healthcheck](https://github.com/parad1so/ngx_dynamic_healthcheck). Цель анализа — изучить структуру, процесс сборки, конфигурацию и зависимости проекта для последующего создания многостадийного Docker-образа, где Nginx с данным модулем собирается на CentOS, а затем разворачивается в production-окружении.

## 2. Структура проекта

Репозиторий проекта имеет хорошо организованную структуру, содержащую все необходимые компоненты для сборки, тестирования и использования модуля.

- **Исходный код (`src/`)**: Содержит исходные файлы модуля, написанные на C и C++. Ключевые файлы:
  - `ngx_dynamic_healthcheck.cpp`: Основная логика модуля.
  - `ngx_http_dynamic_healthcheck.cpp`: Реализация для HTTP-модуля.
  - `ngx_stream_dynamic_healthcheck.cpp`: Реализация для Stream-модуля.
  - `ngx_dynamic_healthcheck_api.cpp`: Код для HTTP API реконфигурации.
  - `config`: Конфигурационный файл, используемый системой сборки Nginx для подключения модуля.

- **Скрипты сборки**: 
  - `build.sh`: Основной скрипт для сборки Nginx с модулем `ngx_dynamic_healthcheck` и `ngx_dynamic_upstream`. Он автоматически загружает необходимые версии Nginx, PCRE и Zlib.
  - `build_with_lua.sh`: Альтернативный скрипт сборки, который дополнительно включает поддержку Lua.

- **Документация и тесты**:
  - `README.markdown`: Подробное руководство по установке, настройке и использованию модуля с примерами конфигурации.
  - `t/`: Каталог, содержащий тестовые сценарии для проверки корректной работы модуля.

## 3. Процесс сборки на CentOS

Процесс сборки полностью автоматизирован с помощью скрипта `build.sh`. Для создания production-сборки в Docker необходимо воспроизвести шаги этого скрипта.

**Этапы сборки:**

1. **Подготовка сборочного окружения**: Установка необходимых инструментов для компиляции.
2. **Загрузка исходных кодов**: Скрипт скачивает архивы с исходными кодами:
   - Nginx (версия 1.24.0)
   - PCRE (версия 10.37)
   - Zlib (версия 1.2.11)
   - Модуль `ngx_dynamic_upstream` (из репозитория на GitHub)
3. **Конфигурация Nginx**: Выполняется скрипт `./configure` со следующими ключевыми параметрами:
   - `--with-stream`: Включает модуль для обработки TCP/UDP трафика.
   - `--add-module=.../ngx_dynamic_healthcheck`: Подключает текущий модуль.
   - `--add-module=.../ngx_dynamic_upstream`: Подключает зависимый модуль `ngx_dynamic_upstream`.
4. **Компиляция и установка**: Стандартные команды `make` и `make install` для сборки и установки Nginx в указанный префикс.

## 4. Зависимости для сборки

Для успешной сборки Nginx с модулем на CentOS потребуются следующие пакеты и библиотеки:

- **Основные инструменты компиляции**:
  - `gcc`: Компилятор C.
  - `g++`: Компилятор C++ (требуется, т.к. модуль написан на C++).
  - `make`: Утилита для автоматизации сборки.

- **Библиотеки для сборки Nginx**:
  - `pcre-devel`: Библиотека для поддержки регулярных выражений (PCRE).
  - `zlib-devel`: Библиотека для сжатия данных (zlib).
  - `openssl-devel`: Библиотека для поддержки SSL/TLS.

- **Утилиты**:
  - `git`: Для клонирования репозиториев (`ngx_dynamic_healthcheck` и `ngx_dynamic_upstream`).
  - `wget` или `curl`: Для загрузки архивов с исходными кодами.

- **Специфическая зависимость**:
  - `libstdc++`: Стандартная библиотека C++, которая требуется для корректной линковки модуля. Это указано в файле `config` (`ngx_module_libs="-lstdc++"`).

## 5. Конфигурация и использование модуля

Модуль `ngx_dynamic_healthcheck` предоставляет гибкие возможности для настройки проверок состояния (health checks) для upstream-серверов.

- **Основные директивы**:
  - `healthcheck`: Задает глобальные параметры проверок в блоке `http`.
  - `check`: Определяет специфичные параметры проверки для конкретного `upstream`.

- **Типы проверок**: 
  - `http`: Отправка HTTP-запроса и анализ кода ответа.
  - `tcp`: Проверка доступности TCP-порта.
  - `ssl`: Проверка доступности SSL-порта.

- **Динамическая реконфигурация**: Модуль предоставляет HTTP API для управления проверками в реальном времени без перезагрузки Nginx. Это позволяет:
  - Получать текущий статус проверок (`/healthcheck/status`).
  - Обновлять параметры проверок на лету (`/healthcheck/update`).
  - Временно отключать или включать хосты.

- **Пример конфигурации**:
  ```nginx
  http {
      healthcheck fall=2 rise=2 interval=60 timeout=10000 type=tcp;

      upstream backend {
          zone backend_zone 64k;
          server backend1.example.com;
          server backend2.example.com;

          check fall=3 rise=2 interval=5 timeout=1000 type=http;
          check_request_uri GET /health;
          check_response_codes 200;
      }

      server {
          listen 80;
          location / {
              proxy_pass http://backend;
          }
      }
  }
  ```

## 6. Требования к Runtime-среде

Для работы Nginx, собранного с модулем `ngx_dynamic_healthcheck`, в production-контейнере необходимы следующие компоненты:

- **Собранный бинарный файл Nginx**.
- **Базовые системные библиотеки**, от которых зависит Nginx (например, `libc`, `pcre`, `zlib`, `openssl`). В минимальном образе (типа `alpine` или `distroless`) их может потребоваться установить дополнительно.
- **Конфигурационные файлы Nginx** (`nginx.conf` и другие, если используются).
- **Каталоги для временных файлов и логов**, настроенные в `nginx.conf`.
- **Пользователь `nginx`**, от имени которого будет запускаться рабочий процесс.

## 7. Заключение и рекомендации для Docker-сборки

Анализ проекта показал, что `ngx_dynamic_healthcheck` является мощным и гибким инструментом для мониторинга состояния upstream-серверов в Nginx. Для создания Docker-образа рекомендуется использовать многостадийную сборку:

1.  **Сборочный стейдж (на базе CentOS)**:
    - Установить все сборочные зависимости (`gcc`, `g++`, `make`, `pcre-devel`, `zlib-devel`, `openssl-devel`, `git`, `wget`).
    - Клонировать репозитории `ngx_dynamic_healthcheck` и `ngx_dynamic_upstream`.
    - Выполнить скрипт `build.sh` для компиляции Nginx.
2.  **Production-стейдж (на базе минимального образа, например, `nginx:alpine`)**:
    - Скопировать собранный бинарный файл Nginx и необходимые модули из сборочного стейджа.
    - Скопировать конфигурационные файлы Nginx.
    - Убедиться в наличии всех runtime-зависимостей.

Такой подход позволит создать легковесный и безопасный production-образ, содержащий только необходимые для работы компоненты.